# 初動メール自動送信

応募者シートの未送信行を検出し、年齢に応じたテンプレートで自動返信メールを送信するツールです。

## 処理フロー

```
設定SS「ユーザ」シート
  メール送信=TRUE? ──No──→ スキップ
       │Yes
       ▼
メール文面列のSS →「応募者シート」
  メール送信済=空? ──No──→ スキップ
  応募日時が直近1日? ──No──→ スキップ
       │Yes
       ▼
同じSS →「メール管理」シート
  クライアント名で照合
  年齢 ≤ 34 → 「34歳以下」列の文面
  年齢 ≥ 35 → 「35歳以上」列の文面
       │
       ▼
SMTP送信
  FROM: ユーザシートのメール列
  TO:   応募者シートのメールアドレス列
  本文: メール管理シートの文面
       │
       ▼
応募者シートの「メール送信済」列に送信日時を記録
```

## ファイル構成

```
初動メール/
├── auto_reply.py          # メインスクリプト（エントリーポイント）
├── config.py              # 設定・定数
├── sheets.py              # Google Spreadsheet 操作
├── mailer.py              # SMTP メール送信
├── logger.py              # ログ出力（画面+ファイル）
├── 必要パッケージ.txt       # Python 依存パッケージ
├── .env.example            # 環境変数テンプレート
├── 初期セットアップ.bat     # 初回セットアップ用
├── 実行.bat               # タスクスケジューラから実行
├── 実行_dry_run.bat        # 送信なしテスト用
├── タスク登録.ps1          # タスクスケジューラ登録
└── README.md              # このファイル
```

## セットアップ

### 1. 初期セットアップ

`初期セットアップ.bat` をダブルクリックして実行します。

以下が自動で行われます:
- Python 仮想環境の作成
- 依存パッケージのインストール
- `.env` ファイルの作成

### 2. 認証情報の設定

**方法A: credentials.json（推奨）**

Google サービスアカウントの JSON キーファイルを `credentials.json` としてこのフォルダに配置します。

**方法B: 環境変数**

`.env` ファイルを編集し、`GOOGLE_CREDENTIALS` に JSON を1行で貼り付けます。

### 3. 動作確認

`実行_dry_run.bat` をダブルクリックして実行します。

`--dry-run` モードではメールを実際に送信せず、処理内容の確認だけ行います。

### 4. タスクスケジューラに登録

管理者権限の PowerShell で以下を実行します:

```powershell
# デフォルト（5分間隔）
.\タスク登録.ps1

# 間隔を変更する場合（例: 10分間隔）
.\タスク登録.ps1 -IntervalMinutes 10
```

## コマンドライン引数

```
python auto_reply.py [オプション]

オプション:
  --dry-run          メール送信をスキップし、処理内容を表示のみ
  --account NAME     指定したクライアント名のアカウントのみ処理
```

### 使用例

```bash
# 全アカウントを処理（通常実行）
python auto_reply.py

# 送信なしで確認
python auto_reply.py --dry-run

# 特定アカウントのみ処理
python auto_reply.py --account "A社"

# 特定アカウントを送信なしで確認
python auto_reply.py --dry-run --account "A社"
```

## スプレッドシート設計

### 設定SS（ユーザシート）

| 列名 | 用途 |
|------|------|
| メール | SMTP送信元アドレス & ログイン用ユーザ名 |
| パス | SMTPログイン用パスワード |
| クライアント名 | テンプレート照合用 |
| メール送信 | TRUE のアカウントのみ処理対象 |
| メール文面 | テンプレート&応募者SSのスプレッドシートID（URLでもOK） |

### 応募者シート

| 列名 | 用途 |
|------|------|
| メール送信済 | 空=未送信（処理対象）、送信後に日時が記録される |
| 応募日時 | 直近1日以内のみ処理対象 |
| 名前 | 応募者の名前 |
| 年齢 | テンプレート出し分け（34以下/35以上） |
| メールアドレス | メール送信先 |
| クライアント名 | テンプレート照合用 |

### メール管理シート

| 列名 | 用途 |
|------|------|
| クライアント名 | 応募者のクライアント名と照合 |
| 件名 | メールの件名テンプレート（空の場合はデフォルト件名を使用） |
| 34歳以下 | 34歳以下の応募者向けテンプレート文面 |
| 35歳以上 | 35歳以上の応募者向けテンプレート文面 |

### テンプレートのプレースホルダー

件名・本文内で以下のプレースホルダーが使用できます:

| プレースホルダー | 内容 |
|-----------------|------|
| `$name` | 応募者名 |
| `$title` | 求人タイトル |
| `$age` | 年齢 |
| `$client_name` | クライアント名 |

**例（件名）**: `$name様 ご応募ありがとうございます`

**例（本文）**: `$name様\n\nこの度は$titleにご応募いただき...`

※ `\n` は改行に変換されます

## ログ

- ログファイルは `logs/` フォルダに出力されます
- ファイル名: `YYYYMMDD_HHMMSS.log`
- 保管期間: 1日（前日以前のログは自動削除）
- 画面とファイルの両方に出力されます

## トラブルシューティング

### Google認証エラー

```
エラー: Google認証情報が見つかりません
```

→ `credentials.json` を配置するか、`.env` の `GOOGLE_CREDENTIALS` を設定してください

### SMTP認証エラー

```
SMTP認証エラー: (535, ...)
```

→ 設定SSの「メール」列と「パス」列の値を確認してください
→ ムームードメインのメール設定でSMTP接続が許可されているか確認してください

### テンプレートが見つからない

```
テンプレートなし: クライアント名「A社」がメール管理シートに見つかりません
```

→ メール管理シートの「クライアント名」列と、応募者シートの「クライアント名」列が完全一致しているか確認してください（余分なスペース等に注意）

### 応募者が0件

```
未送信の応募者はいません
```

→ 応募者シートに「メール送信済」が空かつ「応募日時」が直近1日以内の行があるか確認してください
