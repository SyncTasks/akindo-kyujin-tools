## 🎯 プロジェクト: akindo-kyujin-tools

### 概要
- **目的**: 応募者シートを監視し、未送信の応募者に年齢に応じた定型文メールを自動送信するCLIツール
- **対象**: チーム内利用（求人管理業務の自動化）
- **参考**: [SyncTasks/Indeed-automation](https://github.com/SyncTasks/Indeed-automation/tree/main/ムームードメイン応募転記)
- **スコープ**: MVP（応募者シート読み取り→年齢判定→テンプレート出し分け→メール送信→送信済み更新）

### 技術スタック
- **言語**: Python 3.10+
- **メール送信**: SMTP（smtplib）→ `smtp.muumuu-mail.com:587` (TLS)
- **設定管理**: Google Spreadsheet（gspread + google-auth）
- **実行環境**: Windows VPS + タスクスケジューラ

### アーキテクチャ

```
┌──────────────────────────────────────────────────────────┐
│ ① 設定スプレッドシート (1HzSM76j...)                       │
│    「ユーザ」シート (gid=72811622)                          │
│     ├─ メール送信=TRUE のアカウントを対象                     │
│     ├─ 「メール」「パス」列 → SMTP認証情報                    │
│     ├─ 「クライアント名」列 → クライアント識別                 │
│     └─ 「メール文面」列 → ★スプレッドシートID（②を参照）      │
└──────────────┬───────────────────────────────────────────┘
               │ メール文面列のスプレッドシートID
               ▼
┌──────────────────────────────────────────────────────────┐
│ ② テンプレート＆応募者スプレッドシート（IDで動的参照）         │
│                                                            │
│  「応募者シート」— 処理対象の応募者一覧                       │
│   ├─ メール送信済=空 → 未送信 → 処理対象                     │
│   ├─ 名前, 年齢, メールアドレス → 送信に必要な情報             │
│   └─ クライアント名 → テンプレート照合用                      │
│                                                            │
│  「メール管理」シート — クライアント別・年齢別テンプレート       │
│   ├─ クライアント名列 → 応募者のクライアント名と照合            │
│   ├─ 34歳以下列 → 34歳以下の応募者向け文面                    │
│   └─ 35歳以上列 → 35歳以上の応募者向け文面                    │
└──────────────┬───────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────┐
│ auto_reply.py (メインスクリプト)                             │
│  1. ①設定SSからメール送信=TRUEのアカウント一覧取得            │
│  2. 各アカウントの「メール文面」列 → ②のスプレッドシートIDへ    │
│  3. ②の「応募者シート」からメール送信済=空の行を取得            │
│  4. ②の「メール管理」シートからクライアント名で照合→文面取得    │
│  5. 応募者の年齢で「34歳以下」or「35歳以上」テンプレート選択    │
│  6. SMTP送信（メール列+パス列の認証情報で送信）               │
│  7. 応募者シートの「メール送信済」列を更新                     │
└──────────────────────────────────────────────────────────┘
               │
               ▼
       Windows タスクスケジューラ（定期実行）
```

### スプレッドシート設計

#### ① 設定スプレッドシート（既存: `1HzSM76jUtUOzHiy1zg3Ivqg_-nTn0iFwVwrzG82hQzU`）

**「ユーザ」シート（gid=72811622）** — 対象クライアント & SMTP認証情報

| メール | パス | クライアント名 | 媒体名 | is_active | メール送信 | メール文面 |
|--------|------|----------------|--------|-----------|-----------|-----------|
| user@example.com | pass123 | A社 | Indeed | TRUE | TRUE | 1xBcDeFgH... |

- **フィルタ条件**: `メール送信=TRUE` のアカウントのみ処理対象
- **SMTP認証**: `メール`列（送信元アドレス兼ユーザ名）+ `パス`列（パスワード）
- **テンプレート＆応募者参照**: `メール文面`列のスプレッドシートIDで②へ

#### ② テンプレート＆応募者スプレッドシート（メール文面列のIDで動的参照）

**「応募者シート」** — 応募者一覧（参考リポが書き込む出力先）

| メール送信済 | クライアント | 職種 | 応募日時 | 都道府県 | エリア | 名前 | 年齢 | 応募先求人（URL） | 施設形態 | 施設形態詳細 | ふりがな | メールアドレス | 電話番号 | 生年月日 | 性別 | 住所 | タイトル | クライアント名 | 備考 | pdfURL | アカウントID | 応募者ID | 割り当て | 集計状況 | 媒体 | 応募先企業名 | 性 | 課金判定1 | 重複判定 | 最終課金額 | 課金月 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

- **処理対象**: `メール送信済`列が空（未送信）かつ `応募日時`が直近1日以内の行
- **送信先**: `メールアドレス`列
- **年齢判定**: `年齢`列の値で出し分け（34以下 / 35以上）
- **処理後**: `メール送信済`列を更新（送信日時 or TRUE）

**「メール管理」シート** — クライアント別・年齢別テンプレート

| クライアント名 | 件名 | 34歳以下 | 35歳以上 |
|----------------|------|----------|----------|
| A社 | $name様 ご応募ありがとうございます | $name様\n\nこの度は... | $name様\n\nこの度は... |
| B社 | ... | ... | ... |

- **照合条件**: 応募者シートの「クライアント名」とメール管理の「クライアント名」が一致
- **件名**: 「件名」列のテンプレート（空の場合はデフォルト「ご応募ありがとうございます【タイトル】」）
- **出し分け**: 応募者の`年齢`列の値 → 34以下なら「34歳以下」列、35以上なら「35歳以上」列
- **プレースホルダー**: `$name`, `$title`, `$age`, `$client_name` が件名・本文で使用可能

---

## 🔴 フェーズ1: 基盤構築 `cc:TODO`

- [ ] プロジェクト初期化（pyproject.toml / requirements.txt）
- [ ] ディレクトリ構成の作成
- [ ] 環境変数の設計（.env.example: GOOGLE_CREDENTIALS）
- [ ] Google Spreadsheet認証モジュール（参考リポのパターン流用）
- [ ] ログ出力モジュール（TeeWriter方式、画面+ファイル出力）

## 🟡 フェーズ2: コア機能 `cc:TODO`

- [ ] 設定SSからアカウント読み込み（メール送信=TRUEフィルタ） `[feature:security]`
- [ ] 応募者シート読み込み（メール文面列のID→応募者シート→メール送信済=空 & 応募日時が直近1日以内をフィルタ）
- [ ] メール管理シート読み込み（同じSSの「メール管理」シート→クライアント名で照合）
- [ ] 年齢に応じたテンプレート選択（年齢列 ≤34 → 34歳以下、≥35 → 35歳以上）
- [ ] SMTP送信モジュール（ムームードメインSMTP、日本語対応） `[feature:security]`
- [ ] 送信後の応募者シート更新（メール送信済列を更新）
- [ ] メイン処理フロー（読み込み→年齢判定→テンプレート選択→送信→更新）

## 🟢 フェーズ3: 運用準備 `cc:TODO`

- [ ] CLIインターフェース（argparse: --dry-run, --account 等）
- [ ] Windows用バッチファイル（実行.bat, 初期セットアップ.bat）
- [ ] タスクスケジューラ登録用スクリプト
- [ ] エラーハンドリング強化（リトライ、タイムアウト）
- [ ] 使い方ドキュメント（README.md）

## 🔵 フェーズ4: 仕上げ `cc:TODO`

- [ ] 動作確認（--dry-run モードでテスト）
- [ ] セキュリティ確認（認証情報の取り扱い）
- [ ] Git初期化 & 初回コミット
